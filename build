#!/usr/bin/env bash

set -euo pipefail

numCpus="$(grep -c "^processor" /proc/cpuinfo)"
jobs=""
if [[ ! -e .cabal-sandbox ]]; then
    echo "No cabal sandbox found. Installing Shake."
    cabal sandbox init
    cabal install shake \
        -j$numCpus \
        --ghc-options=-j$numCpus \
        --disable-profiling \
        --disable-executable-profiling \
        &
    jobs+=" $!"
fi
if [[ ! -e controller/.git ]]; then
    echo "Firmware directory not found. Updating submodules."
    git submodule init
    git submodule update &
    jobs+=" $!"
fi
for job in $jobs; do
    wait "$job"
done

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  SELFDIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$SELFDIR/$SOURCE"
done
SELFDIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
cd $SELFDIR

export EUID

cabal exec runghc -- \
    -Wall \
    -rtsopts -with-rtsopts=-I0 \
    -XLambdaCase \
    Build.hs \
    --colour \
    "$@"

